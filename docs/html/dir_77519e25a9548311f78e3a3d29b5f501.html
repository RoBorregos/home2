<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Roborregos @Home documentation: /home/deivideich/roborregos/home_ws/src/home2/hri Directory Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Roborregos @Home documentation<span id="projectnumber">&#160;1.0.0</span>
   </div>
   <div id="projectbrief">Class documentation for the Roborregos @Home project</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('dir_77519e25a9548311f78e3a3d29b5f501.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">hri Directory Reference</div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 id="header-subdirs" class="groupheader"><a id="subdirs" name="subdirs"></a>
Directories</h2></td></tr>
<tr class="memitem:display" id="r_display"><td class="memItemLeft" align="right" valign="top"><span class="iconfolder"><div class="folder-icon"></div></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_81fc633c1595342bc30024b428490014.html">display</a></td></tr>
<tr class="memitem:packages" id="r_packages"><td class="memItemLeft" align="right" valign="top"><span class="iconfolder"><div class="folder-icon"></div></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_7c735ba59def75b3c235195299e3b6c1.html">packages</a></td></tr>
</table>
<a name="details" id="details"></a><h2 id="header-details" class="groupheader">Detailed Description</h2>
<h1 class="doxsection"><a class="anchor" id="autotoc_md119"></a>
HRI</h1>
<p>Tree structure</p>
<div class="fragment"><div class="line">home2</div>
<div class="line">│</div>
<div class="line">│frida_interfaces # Contains the interfaces for the project</div>
<div class="line">├── hri</div>
<div class="line">│   ├── msg</div>
<div class="line">│   └── srv</div>
<div class="line">│</div>
<div class="line">│hri</div>
<div class="line">├── packages # Contains packages for the project</div>
<div class="line">│   ├── nlp</div>
<div class="line">│   └── speech</div>
<div class="line">│       ├── CMakeLists.txt</div>
<div class="line">│       ├── launch</div>
<div class="line">│       ├── package.xml</div>
<div class="line">│       ├── scripts</div>
<div class="line">│       │   └── say.py # Allows robot to speak</div>
<div class="line">│       └── speech</div>
<div class="line">│           ├── __init__.py</div>
<div class="line">│           ├── speech_api_utils.py # Contains util functions for speech</div>
<div class="line">│           └── wav_utils.py # Contians util functions for wav files</div>
<div class="line">├── README.md # This file</div>
<div class="line">└── requirements # Python dependencies for the project</div>
<div class="line">    ├── nlp.txt</div>
<div class="line">    └── speech.txt</div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="autotoc_md120"></a>
Setup with docker</h1>
<p>Run the script <span class="tt">setup.bash</span> located in <span class="tt">home2/docker/hri</span> to setup the configuration for docker.</p>
<p>In addition, the following files are required:</p><ul>
<li><span class="tt">docker/hri/.env</span>: Contains the environment variables for the docker compose files. <span class="tt">docker/hri/.env.example</span> contains examples of the required variables.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md121"></a>
Using with docker</h1>
<div class="fragment"><div class="line"># Build base image</div>
<div class="line"># pwd -&gt; home2/docker</div>
<div class="line">docker compose -f cuda.yaml build</div>
<div class="line"># or -&gt; docker compose -f cpu.yaml build</div>
<div class="line"> </div>
<div class="line"># Build and run HRI containers</div>
<div class="line"># pwd -&gt; home2/docker/hri</div>
<div class="line">docker compose up</div>
<div class="line"> </div>
<div class="line"># Enter the container (this container has the ros 2 environment)</div>
<div class="line">docker exec -it home2-hri-cuda-devices bash</div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="autotoc_md122"></a>
Running the project</h1>
<p>Most of the final commands will be executed using the docker compose file.</p>
<p>However, some testing commands are the following:</p>
<div class="fragment"><div class="line"># Launch HRI (includes speech, and nlp)</div>
<div class="line">ros2 launch speech hri_launch.py</div>
<div class="line"> </div>
<div class="line"># Speech (Remember to start the stt docker before, this is done automatically if running the hri docker compose file)</div>
<div class="line">ros2 launch speech devices_launch.py</div>
<div class="line"> </div>
<div class="line"># Say something</div>
<div class="line">ros2 service call /hri/speech/speak frida_interfaces/srv/Speak &quot;{text: \&quot;Go to the kitchen and grab cookies\&quot;}&quot;</div>
<div class="line"> </div>
<div class="line"># Extract data from a sentence</div>
<div class="line">ros2 service call /hri/nlp/data_extractor frida_interfaces/srv/ExtractInfo &quot;{full_text: &#39;Hello, my name is Oscar&#39;, data: &#39;name&#39;}&quot;</div>
<div class="line"> </div>
<div class="line"># Is positive</div>
<div class="line">ros2 service call /hri/nlp/is_positive frida_interfaces/srv/IsPositive &quot;{text: &#39;I confirm&#39;}&quot;</div>
<div class="line">ros2 service call /hri/speech/STT frida_interfaces/srv/STT {}</div>
<div class="line"> </div>
<div class="line"># NLP</div>
<div class="line">ros2 launch nlp nlp_launch.py</div>
<div class="line"> </div>
<div class="line">ros2 topic pub /speech/raw_command std_msgs/msg/String &quot;data: Go to the kitchen and grab cookies&quot; --once</div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="autotoc_md123"></a>
Other useful commands</h1>
<p>Source the environment (this is automatically done in the .bashrc) </p><div class="fragment"><div class="line">source /workspace/install/setup.bash</div>
</div><!-- fragment --><p>Build the hri packages (this is automatically done in <span class="tt">hri-ros.yaml</span> docker compose file) </p><div class="fragment"><div class="line">colcon build --symlink-install --packages-select task_manager frida_interfaces frida_constants speech nlp embeddings</div>
</div><!-- fragment --><p>Enable file permissions for the current user, this is useful if there is a mismatch between the user in the container and the user in the host. </p><div class="fragment"><div class="line"># pwd -&gt; home2</div>
<div class="line">sudo chown -R $(id -u):$(id -g) .</div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="autotoc_md124"></a>
Speech pipeline</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md125"></a>
AudioCapturer.py</h2>
<p>Captures raw audio in chunks and publishes it.</p>
<ul>
<li>publish -&gt; rawAudioChunk</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md126"></a>
KWS.py</h2>
<p>Uses porcupine to detect kew words sush as "Frida".</p>
<ul>
<li>subscribe -&gt; rawAudioChunk</li>
<li>publish -&gt; keyword_detected</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md127"></a>
UsefulAudio.py</h2>
<p>Uses silero VAD to identify speech in raw audio and publish it to UsefulAudio.</p>
<ul>
<li>subscribe -&gt; rawAudioChunk | saying | keyword_detected</li>
<li>publish -&gt; UsefulAudio | AudioState | colorInstruction | /ReSpeaker/light</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md128"></a>
Hear.py</h2>
<p>Takes UsefulAudio, performs STT with gRPC servers and publishes it.</p>
<ul>
<li>subscribe -&gt; UsefulAudio</li>
<li>publish -&gt; /speech/transcription</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md129"></a>
Setup speech default sink and source</h1>
<p>Sinks and sources are the audio devices that pulseaudio uses to play and record audio. Setting the default sink and source is useful to make sure that the audio is played and recorded from the correct device.</p>
<div class="fragment"><div class="line"># Set default sink</div>
<div class="line">nano ~/.config/pulse/default.pa</div>
<div class="line"># Add the following line</div>
<div class="line"> </div>
<div class="line"># Respeaker 4 mic array</div>
<div class="line">set-default-source alsa_input.usb-SEEED_ReSpeaker_4_Mic_Array__UAC1.0_-00.multichannel-input</div>
<div class="line"> </div>
<div class="line"># Frida&#39;s speaker</div>
<div class="line">set-default-sink alsa_output.usb-GeneralPlus_USB_Audio_Device-00.analog-stereo</div>
<div class="line"> </div>
<div class="line"># Restart pulseaudio (add to .bashrc)</div>
<div class="line">pulseaudio -k &amp;&amp; pulseaudio --start</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md130"></a>
Debug speech devices</h2>
<p>Sinks (Speakers)</p>
<div class="fragment"><div class="line"># See default sink</div>
<div class="line">pactl info | grep &quot;Default Sink&quot;</div>
<div class="line"># Set default sink</div>
<div class="line">pactl set-default-sink &lt;index&gt;</div>
<div class="line"># List all sinks</div>
<div class="line">pactl list short sinks</div>
</div><!-- fragment --><p>Sources (Microphones)</p>
<div class="fragment"><div class="line"># See default source</div>
<div class="line">pactl info | grep &quot;Default Source&quot;</div>
<div class="line"># Set default source</div>
<div class="line">pactl set-default-source &lt;index&gt;</div>
<div class="line"># List all source</div>
<div class="line">pactl list short sources</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md131"></a>
Speaker</h2>
<p>If the speaker isn't loud, make sure to increase the volume level in the device that controlls the speaker. </p><div class="fragment"><div class="line">amixer -D pulse sset Master 100%</div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="autotoc_md132"></a>
Download openwakeword base model</h1>
<div class="fragment"><div class="line">python3</div>
<div class="line">import openwakeword</div>
<div class="line">openwakeword.utils.download_models()</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a href="dir_77519e25a9548311f78e3a3d29b5f501.html">hri</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
